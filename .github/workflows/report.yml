name: Report Build and Publish

permissions:
  contents: write


# –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é: –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00 UTC (–º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å)
#  schedule:
#    - cron: '0 0 * * *'
on:
  workflow_dispatch:        # –∞ —Ç–∞–∫–∂–µ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  build_and_deploy:
    runs-on: self-hosted # ubuntu-latest # 

    steps:
      # 1) –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ —Ü–µ–ª–∏–∫–æ–º, —á—Ç–æ–±—ã –ø–æ—è–≤–∏–ª–∞—Å—å –ø–∞–ø–∫–∞ reports/ –∏ docs/ (–æ—Ç –ø—Ä–æ—à–ª–æ–≥–æ —Ä–∞–∑–∞)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –≤—Å–µ –≤–µ—Ç–∫–∏ –∏ –º–æ–∂–Ω–æ –±—ã–ª–æ –∫–æ–º–º–∏—Ç–∏—Ç—å –≤ publish
          persist-credentials: true

      # 2) –ö–ª–æ–Ω–∏—Ä—É–µ–º –ø—Ä–∏–≤–µ—Ç–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: Checkout reports repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0
          repository: dperov-org/ai-bot       # –∑–∞–º–µ–Ω–∏—Ç–µ your-org/reports-repo –Ω–∞ —Ç–æ—á–Ω—ã–π owner/name –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —Ä–µ–ø–æ
          path: ai-bot                    # –∫—É–¥–∞ –∫–ª–æ–Ω–∏—Ä—É–µ–º (–ø–æ–¥–ø–∞–ø–∫–∞ –≤–Ω—É—Ç—Ä–∏ —Ä–∞–±–æ—á–µ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞)
#          token: ${{ secrets.PAT }}  # PAT —Å –ø—Ä–∞–≤–æ–º –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ–º—É —Ä–µ–ø–æ


      # 2) –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: Setup Python 3.x
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4) –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —Ä–µ–ø–æ
      - name: Install reports-repo dependencies
        run: |
          if [ -f ai-bot/requirements.txt ]; then
            pip install -r ai-bot/requirements.txt
          fi

      - name: Create .env file with secrets
        run: |
          cat <<EOF > ai-bot/.env
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          DB_PASSWORD=${{ secrets.TELEGRAM_TOKEN }}
          EOF


      # 3) –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞
      - name: Generate report (Markdown + images)
        run: |
          python reports/generate_reports.py

      # 4) –î–µ–ª–∞–µ–º git-–∫–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ø–∞–ø–∫—É docs/ (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å) –∏ –ø—É—à–∏–º –æ–±—Ä–∞—Ç–Ω–æ –≤ publish
      - name: Commit and push docs/
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # –ü—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–Ω–æ–≤—ã–µ/–æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ docs/)
          git add docs/
          if ! git diff --cached --quiet; then
            git commit -m "üìà Auto-update report: $(date -u +'%Y-%m-%d %H:%M UTC')"
            git push origin HEAD:publish
          else
            echo "No changes in docs/, skip commit."
          fi

      # 5) (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –í—ã–≤–µ—Å—Ç–∏ —Å—Å—ã–ª–∫—É –Ω–∞ Pages –≤ –ª–æ–≥–∞—Ö
      - name: Show GitHub Pages URL
        run: |
          echo "Pages should be available at https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
